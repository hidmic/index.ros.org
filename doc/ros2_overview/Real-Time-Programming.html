<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Background</title>
    <meta name="description" content="a community-maintained index of robotics software
">

    <link rel="canonical" href="https://ros-infrastructure.github.io/index.ros.org//doc/ros2_overview/Real-Time-Programming.html">
    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/main.css">
    

    <script type="text/javascript" src=/js/jquery.js></script>
    <script src=/bootstrap/js/bootstrap.min.js type="text/javascript"></script>
    <script src=/js/jquery-cookie-1.4.1/jquery.cookie.js type="text/javascript"></script>

    <script type="text/javascript" src=/js/ga.js async></script>
    <script type="text/javascript" src=/js/toc.js></script>
    
    <script src=/js/distro_switch.js></script>

    <!-- Pre-fetch search index files -->
    
    
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">
    <div class="container-fluid" style="margin-bottom: 10px">
      <div class="row">


        <div class="col-sm-12 col-md-9" style="margin-top: 8px">
          <div class="row">
            <!-- title -->
            <div class="col-xs-12 col-sm-3 col-md-3" style="white-space:nowrap;">
              <a class="site-title" href="/">ROS Index</a> <sup><a href="https://github.com/rosindex/rosindex/issues/new" style="vertical-align:super;" class="label label-warning" target="_blank">BETA</a></sup>
            </div>

            <!-- main links -->
            <div class="col-xs-12 col-sm-9 col-md-9 text-right">
              <ul class="list-inline" style="margin-bottom:0px;">
                <li><a class="btn btn-link" href="/about">About</a></li>

                <li class="dropdown">
                  <button id="dLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Index <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                    <li><a href="/packages/page/1/time/">Package List</a></li>
                    <li><a href="/repos/page/1/time/">Repository List</a></li>

                    <li class="hidden" class="divider"></li>


                    <li class="hidden"><a href="/srvs/">Nodes</a></li>
                    <li class="hidden"><a href="/msgs/">Messages</a></li>
                    <li class="hidden"><a href="/srvs/">Services</a></li>
                    <li class="hidden"><a href="/srvs/">Plugins</a></li>

                    <li class="divider"></li>

                    <li><a href="/deps/">System Dependencies</a></li>
                  </ul>
                </li>

                <li class="dropdown disabled">
                  <button id="dLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Doc <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                    
                      
                        
                      
                        
                      
                        
                      
                        
                      
                        
                      
                        
                          <li><a href="/doc/ros2_overview">ROS2 Overview</a></li>
                        
                      
                    
                    <li class="hidden" class="divider"></li>

                    <li class="hidden"><a href="/doc/tutorials">Tutorials</a></li>
                    <li class="hidden"><a href="/doc/readmes">Readmes</a></li>
                    <li class="hidden"><a href="/doc/apis">APIs</a></li>
                  </ul>
                </li>

                <li><a class="btn btn-link" href="/contribute">Contribute</a></li>
                <li><a class="btn btn-link" href="/stats">Stats</a></li>
              </ul>

            </div>
          </div>
        </div>

        <!-- searchbox -->
        <div class="col-sm-12 col-md-3" style="margin-top: 12px">
          <form action="/search/" role="form" method="get">
            <div class="input-group input-group-sm">
              <input type="text" class="form-control" name="q" placeholder="Search ROS packages">
              <span class="input-group-btn">
                <button class="btn btn-default btn-sm" type="submit"><span class="glyphicon glyphicon-search"></span></button>
              </span>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!--
    <a class="site-title" href="/">ROS Index</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/packages">Packages</a>
        <a class="page-link" href="/repos">Repositories</a>
        <a class="page-link" href="/search">Search</a>
      </div>
    </nav>
    -->

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="container-fluid" style="margin-top:20px">
  <div class="container-fluid">
    <div class="row">
      <ol class="breadcrumb">
        <li><a href="/">Home</a></li>
        
        <li class="active">Background</li>
      </ol>
    </div>
    <div class="row">
      <div class="col-md-10">
        <h2 id="background">Background</h2>

<p>Real-time computing is a key feature of many robotics systems, particularly safety- and mission-critical applications such as autonomous vehicles, spacecrafts, and industrial manufacturing.
We are designing and prototyping ROS 2 with real-time performance constraints in mind, since this is a requirement that was not considered in the early stages of ROS 1 and it is now intractable to refactor ROS 1 to be real-time friendly.</p>

<p><a href="http://design.ros2.org/articles/realtime_background.html">This document</a> outlines the requirements of real-time computing and best practices for software engineers. tl;dr:</p>

<p>To make a real-time computer system, our real-time loop must update periodically to meet deadlines.
We can only tolerate a small margin of error on these deadlines (our maximum allowable jitter).
To do this, we must avoid nondeterministic operations in the execution path, things like: pagefault events, dynamic memory allocation/deallocation, and synchronization primitives that block indefinitely.</p>

<p>A classic example of a controls problem commonly solved by real-time computing is balancing an <a href="https://en.wikipedia.org/wiki/Inverted_pendulum">inverted pendulum</a>.
If the controller blocked for an unexpectedly long amount of time, the pendulum would fall down or go unstable.
But if the controller reliably updates at a rate faster than the motor controlling the pendulum can operate, the pendulum will successfully adapt react to sensor data to balance the pendulum.</p>

<p>Now that you know everything about real-time computing, let&#39;s try a demo!</p>

<h2 id="install-and-run-the-demo">Install and run the demo</h2>

<p>The real-time demo was written with Linux operating systems in mind, since many members of the ROS community doing real-time computing use Xenomai or RT_PREEMPT as their real-time solutions.
Since many of the operations done in the demo to optimize performance or OS-specific, the demo only builds and runs on Linux systems.
<strong>So, if you are an OSX or Windows user, don&#39;t try this part!</strong></p>

<p>Also this must be built from source using a the static DDS API. <strong>Currently the only supported implementation is Connext</strong>.</p>

<p>First, follow the instructions to build ROS 2 <a href="Linux-Development-Setup">from source</a> using Connext DDS as the middleware.</p>

<h3 id="run-the-tests">Run the tests</h3>

<p><strong>Before you run make sure you have at least 8Gb of RAM free. With the memory locking, swap will not work anymore.</strong></p>

<p>Source your ROS 2 setup.bash.</p>

<p>Run the demo binary, and redirect the output. You may want to use <code>sudo</code> in case you get permission error:
<code>
pendulum_demo &gt; output.txt
</code></p>

<h2 id="what-the-heck-just-happened">What the heck just happened?</h2>

<p>First, even though you redirected stdout, you will see some output to the console (from stderr):</p>
<div class="highlight"><pre><code class="language-" data-lang="">mlockall failed: Cannot allocate memory
Couldn't lock all cached virtual memory.
Pagefaults from reading pages not yet mapped into RAM will be recorded.
</code></pre></div>
<p>After the initialization stage of the demo program, it will attempt to lock all cached memory into RAM and prevent future dynamic memory allocations using <code>mlockall</code>.
This is to prevent pagefaults from loading lots of new memory into RAM.
(See <a href="http://design.ros2.org/articles/realtime_background.html#memory-management">the realtime design article</a> for more information.)</p>

<p>The demo will continue on as usual when this occurs.
At the bottom of the output.txt file generated by the demo, you&#39;ll see the number of pagefaults encountered during execution:</p>
<div class="highlight"><pre><code class="language-" data-lang="">rttest statistics:
  - Minor pagefaults: 20
  - Major pagefaults: 0
</code></pre></div>
<p>If we want those pagefaults to go away, we&#39;ll have to...</p>

<h3 id="adjust-permissions-for-memory-locking">Adjust permissions for memory locking</h3>

<p>Add to <code>/etc/security/limits.conf</code> (as sudo):</p>
<div class="highlight"><pre><code class="language-" data-lang="">&lt;your username&gt;    -   memlock   &lt;limit in kB&gt;
</code></pre></div>
<p>A limit of <code>-1</code> is unlimited.
If you choose this, you may need to accompany it with <code>ulimit -l unlimited</code> after editing the file.</p>

<p>After saving the file, log out and log back in.
Then rerun the <code>pendulum_demo</code> invocation.</p>

<p>You&#39;ll either see zero pagefaults in your output file, or an error saying that a bad_alloc exception was caught.
If this happened, you didn&#39;t have enough free memory available to lock the memory allocated for the process into RAM.
You&#39;ll need to install more RAM in your computer to see zero pagefaults!</p>

<h3 id="output-overview">Output overview</h3>

<p>To see more output, we have to run the <code>pendulum_logger</code> node.</p>

<p>In one shell with your <code>install/setup.bash</code> sourced, invoke:</p>

<p><code>pendulum_logger</code></p>

<p>You should see the output message:</p>
<div class="highlight"><pre><code class="language-" data-lang="">Logger node initialized.
</code></pre></div>
<p>In another shell with setup.bash sourced, invoke <code>pendulum_demo</code> again.</p>

<p>As soon as this executable starts, you should see the other shell constantly printing output:</p>
<div class="highlight"><pre><code class="language-" data-lang="">Commanded motor angle: 1.570796
Actual motor angle: 1.570796
Mean latency: 210144.000000 ns
Min latency: 4805 ns
Max latency: 578137 ns
Minor pagefaults during execution: 0
Major pagefaults during execution: 0
</code></pre></div>
<p>The demo is controlling a very simple inverted pendulum simulation.
The pendulum simulation calculates its position in its own thread.
A ROS node simulates a motor encoder sensor for the pendulum and publishes its position.
Another ROS node acts as a simple PID controller and calculates the next command message.</p>

<p>The logger node periodically prints out the pendulum&#39;s state and the runtime performance statistics of the demo during its execution phase.</p>

<p>After the <code>pendulum_demo</code> is finished, you&#39;ll have to CTRL-C out of the logger node to exit.</p>

<h3 id="latency">Latency</h3>

<p>At the <code>pendulum_demo</code> execution,, you&#39;ll see the final statistics collected for the demo:</p>
<div class="highlight"><pre><code class="language-" data-lang="">rttest statistics:
  - Minor pagefaults: 0
  - Major pagefaults: 0
  Latency (time after deadline was missed):
    - Min: 3354 ns
    - Max: 2752187 ns
    - Mean: 19871.8 ns
    - Standard deviation: 1.35819e+08

PendulumMotor received 985 messages
PendulumController received 987 messages
</code></pre></div>
<p>The latency fields show you the minimum, maximum, and average latency of the update loop in nanoseconds.
Here, latency means the amount of time after the update was expected to occur.</p>

<p>The requirements of a real-time system depend on the application, but let&#39;s say in this demo we have a 1KHz (1 millisecond) update loop, and we&#39;re aiming for a maximum allowable latency of 5% of our update period.</p>

<p>So, our average latency was really good in this run, but the maximum latency was unacceptable because it actually exceeded our update loop! What happened?</p>

<p>We may be suffering from a non-deterministic scheduler.
If you&#39;re running a vanilla Linux system and you don&#39;t have the RT_PREEMPT kernel installed, you probably won&#39;t be able to meet the real-time goal we set for ourselves, because the Linux scheduler won&#39;t allow you to arbitrarily pre-empt threads at the user level.</p>

<p>See the <a href="https://github.com/ros2/design/blob/gh-pages/articles/realtime.md#multithreaded-programming-and-synchronization">realtime design article</a> for more information.</p>

<p>The demo attempts to set the scheduler and thread priority of the demo to be suitable for real-time performance.
If this operation failed, you&#39;ll see an error message: &quot;Couldn&#39;t set scheduling priority and policy: Operation not permitted&quot;.
You can get slightly better performance by following the instructions in the next section:</p>

<h3 id="setting-permissions-for-the-scheduler">Setting permissions for the scheduler</h3>

<p>Add to <code>/etc/security/limits.conf</code> (as sudo):</p>
<div class="highlight"><pre><code class="language-" data-lang="">&lt;your username&gt;    -   rtprio   98
</code></pre></div>
<p>The range of the rtprio (real-time priority) field is 0-99.
However, do NOT set the limit to 99 because then your processes could interfere with important system processes that run at the top priority (e.g. watchdog).
This demo will attempt to run the control loop at priority 98.</p>

<h2 id="plotting-results">Plotting results</h2>

<p>You can plot the latency and pagefault statistics that are collected in this demo after the demo runs.</p>

<p>Because the code has been instrumented with <a href="https://github.com/ros2/rttest">rttest</a>, there are useful command line tools available to us:</p>

<p>-i Specify how many iterations to run the real-time loop.
Default is 1000.</p>

<p>-u Specify the update period.
Default units are microseconds.
Use the suffix &quot;s&quot; for seconds, &quot;ms&quot; for milliseconds, &quot;us&quot; for microseconds, and &quot;ns&quot; for nanoseconds.
Default update period is 1ms.</p>

<p>-f Specify the name of the file for writing the collected data.</p>

<p>Run the demo again with the name a file to save results to:</p>
<div class="highlight"><pre><code class="language-" data-lang="">pendulum_demo -f pendulum_demo_results
</code></pre></div>
<p>Then run the <code>rttest_plot</code> script on the resulting file:</p>
<div class="highlight"><pre><code class="language-" data-lang="">rttest_plot pendulum_demo_results
</code></pre></div>
<p>This script will produce three files:</p>
<div class="highlight"><pre><code class="language-" data-lang="">pendulum_demo_results_plot_latency.svg
pendulum_demo_results_plot_majflts.svg
pendulum_demo_results_plot_minflts.svg
</code></pre></div>
<p>You can view these plots in an image viewer of your choice.</p>

      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
$(document).ready(
    function() {
      $('#toc').toc({
        title: '',
        listType: 'ul',
        showSpeed: 0,
        headers: 'h2, h3' });
});
</script>

      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-4 col-md-4">
          
            <a href="https://github.com/rosindex">
            <span class="icon  icon--github">
              <svg viewBox="0 0 16 16">
                <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>

            <span class="username">rosindex</span>
          </a>
          |
          <em>generated on 2018-09-26</em>
        
        </div>
        <div class="col-sm-8 col-md-8 text-right">
          <p class="text">a community-maintained index of robotics software
 | <a href="/privacy.txt">privacy</a></p>
        </div>
      </div>
    </div>
  </div>

</footer>


  </body>

</html>
