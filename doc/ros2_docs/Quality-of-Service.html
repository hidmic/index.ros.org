<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Quality of service</title>
    <meta name="description" content="a community-maintained index of robotics software
">

    <link rel="canonical" href="https://ros-infrastructure.github.io/index.ros.org//doc/ros2_docs/Quality-of-Service.html">
    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/main.css">
    

    <script type="text/javascript" src=/js/jquery.js></script>
    <script src=/bootstrap/js/bootstrap.min.js type="text/javascript"></script>
    <script src=/js/jquery-cookie-1.4.1/jquery.cookie.js type="text/javascript"></script>

    <script type="text/javascript" src=/js/ga.js async></script>
    <script type="text/javascript" src=/js/toc.js></script>
    
    <script src=/js/distro_switch.js></script>

    <!-- Pre-fetch search index files -->
    
    
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">
    <div class="container-fluid" style="margin-bottom: 10px">
      <div class="row">


        <div class="col-sm-12 col-md-9" style="margin-top: 8px">
          <div class="row">
            <!-- title -->
            <div class="col-xs-12 col-sm-3 col-md-3" style="white-space:nowrap;">
              <a class="site-title" href="/">ROS Index</a> <sup><a href="https://github.com/rosindex/rosindex/issues/new" style="vertical-align:super;" class="label label-warning" target="_blank">BETA</a></sup>
            </div>

            <!-- main links -->
            <div class="col-xs-12 col-sm-9 col-md-9 text-right">
              <ul class="list-inline" style="margin-bottom:0px;">
                <li><a class="btn btn-link" href="/about">About</a></li>

                <li class="dropdown">
                  <button id="dLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Index <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                    <li><a href="/packages/page/1/time/">Package List</a></li>
                    <li><a href="/repos/page/1/time/">Repository List</a></li>

                    <li class="hidden" class="divider"></li>


                    <li class="hidden"><a href="/srvs/">Nodes</a></li>
                    <li class="hidden"><a href="/msgs/">Messages</a></li>
                    <li class="hidden"><a href="/srvs/">Services</a></li>
                    <li class="hidden"><a href="/srvs/">Plugins</a></li>

                    <li class="divider"></li>

                    <li><a href="/deps/">System Dependencies</a></li>
                  </ul>
                </li>

                <li class="dropdown disabled">
                  <button id="dLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Doc <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                    
                      
                        
                      
                        
                      
                        
                      
                        
                      
                        
                      
                        
                          <li><a href="/doc/ros2_overview">ROS2 Overview</a></li>
                        
                      
                    
                    <li class="hidden" class="divider"></li>

                    <li class="hidden"><a href="/doc/tutorials">Tutorials</a></li>
                    <li class="hidden"><a href="/doc/readmes">Readmes</a></li>
                    <li class="hidden"><a href="/doc/apis">APIs</a></li>
                  </ul>
                </li>

                <li><a class="btn btn-link" href="/contribute">Contribute</a></li>
                <li><a class="btn btn-link" href="/stats">Stats</a></li>
              </ul>

            </div>
          </div>
        </div>

        <!-- searchbox -->
        <div class="col-sm-12 col-md-3" style="margin-top: 12px">
          <form action="/search/" role="form" method="get">
            <div class="input-group input-group-sm">
              <input type="text" class="form-control" name="q" placeholder="Search ROS packages">
              <span class="input-group-btn">
                <button class="btn btn-default btn-sm" type="submit"><span class="glyphicon glyphicon-search"></span></button>
              </span>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!--
    <a class="site-title" href="/">ROS Index</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/packages">Packages</a>
        <a class="page-link" href="/repos">Repositories</a>
        <a class="page-link" href="/search">Search</a>
      </div>
    </nav>
    -->

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="container-fluid" style="margin-top:20px">
  <div class="container-fluid">
    <div class="row">
      <ol class="breadcrumb">
        <li><a href="/">Home</a></li>
        
        <li class="active">Quality of service</li>
      </ol>
    </div>
    <div class="row">
      <div class="col-md-10">
        <h1 id="quality-of-service">Quality of service</h1>

<h2 id="background">Background</h2>

<p>Please read the <a href="/doc/ros2_docs/About-Quality-of-Service-Settings.html">About Quality of Service Settings</a> page for background information about the Quality of Service settings available in ROS 2.</p>

<p>In this demo, we will spawn a node that publishes a camera image and another that subscribes to the image and shows it on the screen.
We will then simulate a lossy network connection between them and show how different quality of service settings handle the bad link.</p>

<h2 id="build-install-the-demo">Build/install the demo</h2>

<h3 id="from-pre-compiled-binaries">From pre-compiled binaries</h3>

<p>Simply download the binary packages for your OS from the <a href="/doc/ros2_docs/Installation.html">installation page</a>.</p>

<h3 id="from-source">From source</h3>

<p>OpenCV is a prerequisite for the QoS demo.
See the <a href="http://docs.opencv.org/doc/tutorials/introduction/table_of_content_introduction/table_of_content_introduction.html#table-of-content-introduction">OpenCV documentation</a> for installation instructions.
Follow the instructions on the <a href="/doc/ros2_docs/Installation.html#building-from-source">installation page</a> for your particular platform.</p>

<h2 id="run-the-demo">Run the demo</h2>

<p>Before running the demo, make sure you have a working webcam connected to your computer.</p>

<p>Once you&#39;ve installed ROS 2, if you&#39;re on Linux, source your setup.bash file:</p>
<div class="highlight"><pre><code class="language-" data-lang="">. &lt;path to ROS 2 install space&gt;/setup.bash
</code></pre></div>
<p>or if you&#39;re on Windows *<em>cmd</em>:
<code>
call &lt;path to ROS 2 install space&gt;/local_setup.bat
</code></p>

<p>Then run:</p>
<div class="highlight"><pre><code class="language-" data-lang="">ros2 run image_tools showimage
</code></pre></div>
<p>Nothing will happen yet.
<code>showimage</code> is a subscriber node that is waiting for a publisher on the <code>image</code> topic.</p>

<p>Note: you have to close the <code>showimage</code> process with <code>Ctrl-C</code> later.
You can&#39;t just close the window.</p>

<p>In a separate terminal, source the install file and run the publisher node:</p>
<div class="highlight"><pre><code class="language-" data-lang="">ros2 run image_tools cam2image
</code></pre></div>
<p>This will publish an image from your webcam. In case you don&#39;t have a camera attached to your computer, there is a commandline option which publishes predefined images.
<code>
ros2 run image_tools cam2image -b
</code></p>

<p>In this window, you&#39;ll see terminal output:</p>
<div class="highlight"><pre><code class="language-" data-lang="">Publishing image #1
Publishing image #2
Publishing image #3
...
</code></pre></div>
<p>A window will pop up with the title &quot;view&quot; showing your camera feed.
In the first window, you&#39;ll see output from the subscriber:</p>
<div class="highlight"><pre><code class="language-" data-lang="">Received image #1
Received image #2
Received image #3
...
</code></pre></div>
<p>Note for OS X users: If you these examples do not work or you receive an error like <code>ddsi_conn_write failed -1</code> then you&#39;ll need to increase your system wide UDP packet size:</p>
<div class="highlight"><pre><code class="language-" data-lang="">$ sudo sysctl -w net.inet.udp.recvspace=209715
$ sudo sysctl -w net.inet.udp.maxdgram=65500
</code></pre></div>
<p>These changes will not persist a reboot. If you want the changes to persist, add these lines to <code>/etc/sysctl.conf</code> (create the file if it doesn&#39;t exist already):</p>
<div class="highlight"><pre><code class="language-" data-lang="">net.inet.udp.recvspace=209715
net.inet.udp.maxdgram=65500
</code></pre></div>
<h3 id="command-line-options">Command line options</h3>

<p>In one of your terminals, add a -h flag to the original command:</p>
<div class="highlight"><pre><code class="language-" data-lang="">ros2 run image_tools showimage -- -h
</code></pre></div>
<p>You&#39;ll see a list of the possible options you can pass to the demo.</p>

<p><code>-h</code>: The help message.</p>

<p><code>-r</code>: Reliability.
There are two options for this policy: reliable or best effort.
Reliable means that values may be reset and the underlying DDS publisher might block, in order for messages to get delivered in order.
Best effort means that messages will get sent as is, and they may get dropped or lost without effecting the behavior of the publisher.</p>

<p><code>-k</code>: History policy (the &quot;k&quot; stands for &quot;keep&quot;).
Determines how DDS buffers messages in the time between the user code that called <code>publish</code> and the time when the message actually gets sent.
There are two options for history: KEEP_ALL and KEEP_LAST.
KEEP_ALL will buffer all messages before they get sent.
KEEP_LAST limits the number of buffered messages to a depth specified by the user.</p>

<p><code>-d</code>: Queue depth.
Only used if the history policy is set to KEEP_LAST.
The queue depth determines the maximum number of not yet received messages that get buffered on the sender&#39;s side before messages start getting dropped.</p>

<p>If you run <code>cam2image -h</code>, you&#39;ll see the same set of command line options and two extras:</p>

<p><code>-s</code>: Toggle displaying the input camera stream.
If you run <code>cam2image -s</code> by itself, you&#39;ll see a camera window.
If you also run <code>showimage</code>, you&#39;ll see two camera windows.</p>

<p><code>-x</code> and <code>-y</code>: Set the size of the camera feed (x sets the width, y sets the height).</p>

<p>The default quality of service settings are tuned for maximum reliability: the reliability policy is reliable, and the history policy is &quot;keep all&quot;.</p>

<p>It&#39;s worth noting that both ends must have the same reliability settings for this to work.
If the consumer requires the publisher to be reliable, DDS will not match them and there won&#39;t be any exchange between them.</p>

<p>We won&#39;t see much of a difference if we change the quality of service settings, since the publisher and subscriber are passing messages over inter-process communication, and messages are unlikely to get dropped if they are travelling within the same machine.</p>

<h3 id="add-network-traffic">Add network traffic</h3>

<p>This next section is Linux-specific.
However, for OS X and Windows you can achieve a similar effect with the utilities &quot;Network Link Conditioner&quot; (part of the xcode tool suite) and &quot;Clumsy&quot; (<a href="http://jagt.github.io/clumsy/index.html">http://jagt.github.io/clumsy/index.html</a>), respectively, but they will not be covered in this tutorial.</p>

<p>We are going to use the Linux network traffic control utility, <code>tc</code> (<a href="http://linux.die.net/man/8/tc">http://linux.die.net/man/8/tc</a>).</p>
<div class="highlight"><pre><code class="language-" data-lang="">sudo tc qdisc add dev lo root netem loss 5%
</code></pre></div>
<p>This magical incantation will simulate 5% packet loss over the local loopback device.
If you use a higher resolution of the images (e.g. <code>-x 640 -y 480</code>) you might want to try a lower packet loss rate (e.g. <code>1%</code>).</p>

<p>Next we start the <code>cam2image</code> and <code>showimage</code>, and we&#39;ll soon notice that both programs seem to have slowed down the rate at which images are transmitted.
This is caused by the behavior of the default QoS settings.
Enforcing reliability on a lossy channel means that the publisher (in this case, <code>cam2image</code>) will resend the network packets until it receives acknowledgement from the consumer (i.e. <code>showimage</code>).</p>

<p>Let&#39;s now try running both programs, but with more suitable settings.
First of all, we&#39;ll use the <code>-r 0</code> option to enable best effort communication.
The publisher will now just attempt to deliver the network packets, and don&#39;t expect acknowledgement from the consumer.
We see now that some of the frame on the <code>showimage</code> side were dropped, the frame numbers in the shell running <code>showimage</code> won&#39;t be consecutive anymore:</p>

<p><img src="https://raw.githubusercontent.com/ros2/demos/master/image_tools/doc/qos-best-effort.png" alt="Best effort image transfer "></p>

<p>When you&#39;re done, remember to delete the queueing discipline:</p>
<div class="highlight"><pre><code class="language-" data-lang="">sudo tc qdisc delete dev lo root netem loss 5%
</code></pre></div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
$(document).ready(
    function() {
      $('#toc').toc({
        title: '',
        listType: 'ul',
        showSpeed: 0,
        headers: 'h2, h3' });
});
</script>

      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-4 col-md-4">
          
            <a href="https://github.com/rosindex">
            <span class="icon  icon--github">
              <svg viewBox="0 0 16 16">
                <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>

            <span class="username">rosindex</span>
          </a>
          |
          <em>generated on 2018-09-26</em>
        
        </div>
        <div class="col-sm-8 col-md-8 text-right">
          <p class="text">a community-maintained index of robotics software
 | <a href="/privacy.txt">privacy</a></p>
        </div>
      </div>
    </div>
  </div>

</footer>


  </body>

</html>
